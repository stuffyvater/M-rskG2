<html>
    <script type="application/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
    <!-- <script src="ipfs.js"></script> -->
    <script src="https://npmcdn.com/ipfs-api/dist/index.js"></script>
    <script type="application/javascript" src="./bower_components/web3/dist/web3.js"></script>
    <script type="application/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
    <script type="application/javascript" src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <body>
    <b>You are:</b> <span id="whoami"></span>
    <h2>Create a Contract!</h2>
    <button id="create">Create!</button>
    <div id="yay"></div>
    <br/>
    <hr>
    <h2>Whitelist a Stakeholder</h2>
    Contract Address: <input type="text" id="contractAddress"/><br/>
    Stakeholder ID: <input type="text" id="stakeholderId"/>
    <button id="submit">Go!</button>
    <div id="yay2"></div>
    <hr>
    <h2>Upload/Amend Document</h2>
    Contract Address: <input type="text" id="contractAddress1"/><br/>
    File: <input type="file" id="file"/>
    <button id="submit1">Go!</button>
  <script type="text/javascript">
    $(document).ready(function() {
      var ethNode = 'http://localhost:8545';
      var adminAccount = '0x03e4ea7c17cc932a9488f84639b774ac376e6e9e';
      var contractAddress = '0x18061eEBc759612E6145B243Be84a44237663c8E';
      $('#whoami').html(adminAccount);
      if (typeof web3 !== 'undefined') {
          web3 = new Web3(web3.currentProvider);
      } else {
          // set the provider you want from Web3.providers
          web3 = new Web3(new Web3.providers.HttpProvider(ethNode));
      }
      var abi = [{"constant":false,"inputs":[{"name":"stakeholder","type":"address"}],"name":"whitelistStakeholder","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"whiteList","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"documentId","type":"uint256"},{"name":"newFingerprint","type":"string"}],"name":"amendDocument","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"documents","outputs":[{"name":"author","type":"address"},{"name":"fingerprint","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"admin","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"inputs":[{"name":"a","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"stakeholder","type":"address"}],"name":"StakeholderWhitelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"documentId","type":"uint256"},{"indexed":false,"name":"author","type":"address"},{"indexed":false,"name":"newFingerprint","type":"string"}],"name":"DocumentAmended","type":"event"}]
      var bytecode = '0x6060604052341561000c57fe5b604051602080610771833981016040528080519060200190919050505b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b505b6106f58061007c6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806326ea4bf614610067578063372c12b11461009d57806355389c3e146100eb578063c2ed2b051461014e578063f851a44014610237575bfe5b341561006f57fe5b61009b600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610289565b005b34156100a557fe5b6100d1600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506103a8565b604051808215151515815260200191505060405180910390f35b34156100f357fe5b61014c600480803590602001909190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506103c8565b005b341561015657fe5b61016c60048080359060200190919050506105bb565b604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018281038252838181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156102275780601f106101fc57610100808354040283529160200191610227565b820191906000526020600020905b81548152906001019060200180831161020a57829003601f168201915b5050935050505060405180910390f35b341561023f57fe5b6102476105fe565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b338073ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156102e75760006000fd5b6001600060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055507f078cba54125a07a375c22702c366fcb4d1029bafd27b1d6e93d813b1d103b6cb82604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b5b5050565b60006020528060005260406000206000915054906101000a900460ff1681565b3360001515600060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151514156104285760006000fd5b6040604051908101604052803373ffffffffffffffffffffffffffffffffffffffff168152602001838152506002600085815260200190815260200160002060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010190805190602001906104ca929190610624565b509050507f2ebfece40746549a3b7549b22060ca8d895e54ac0096edfb3aaee7db4acdc0ee833384604051808481526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001828103825283818151815260200191508051906020019080838360008314610579575b80518252602083111561057957602082019150602081019050602083039250610555565b505050905090810190601f1680156105a55780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a15b5b505050565b60026020528060005260406000206000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600101905082565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061066557805160ff1916838001178555610693565b82800160010185558215610693579182015b82811115610692578251825591602001919060010190610677565b5b5090506106a091906106a4565b5090565b6106c691905b808211156106c25760008160009055506001016106aa565b5090565b905600a165627a7a72305820eaa629ed7f2c5ae8782d98eeb6cbb1d650cc62bba5752607eb822e4b5cdba7800029';

      /* VARIABLES */
      var MyContract = web3.eth.contract(abi);
      $('#create').click(function() {
        MyContract.new(web3.eth.coinbase, {from: web3.eth.coinbase, data: bytecode, gas: 4700000},
          function(e,r) {
              if (e !== null) { // we have an error
                  $('#yay').html('<b>Error</b>: '+e.message);
              }
              else {
                  $('#yay').html('Contract is being created. Click <a target="_blank" href="https://ropsten.etherscan.io/tx/'+r.transactionHash+'">here</a> to view the transaction.');
              }
          })
      });

      $('#submit').click(function() {
        var contractAddress = $('#contractAddress').val();
        var stakeholder = $('#stakeholderId').val();
        var myContractInstance = MyContract.at(contractAddress);
        console.log(myContractInstance);
        console.log(contractAddress);
        myContractInstance.whitelistStakeholder(stakeholder, {from: web3.eth.coinbase, gas: 91000}, function(e,r) {
          console.log(e);
          console.log(r);
          if (!e) {
            $('#yay2').html('Stakeholder whitelisted');
          }
        });
      });

      $('#submit1').click(function() {
        var files = document.getElementById('file').files;
        if (!files.length) {
            alert('Please select a file!');
            return;
        }

        var file = files[0];
        var reader = new FileReader();

        reader.readAsText(file);
        // If we use onloadend, we need to check the readyState.
        reader.onloadend = function(evt) {
            var i = IpfsApi("/ip4/127.0.0.1/tcp/5001");
            i.add(i.Buffer(reader.result), function (err, res){
                if(err || !res)
                  return console.error("ipfs add error", err, res);

                var storedDoc = res[0];
                var fingerprint = storedDoc.hash;

                $("#hashResult").show();
                $("#hashResult").html(fingerprint);
                console.log("fingerprint: "+ fingerprint);
                contract = web3.eth.contract(abi);

                var contractAddress = $("#contractAddress1").val();
                evt.preventDefault();
                var contractInstance = contract.at(contractAddress);

                contractInstance.amendDocument(1234, fingerprint, {from: web3.eth.coinbase, gas: 1000000}, function(e,r){
                  if(e){
                      alert("An error occurred: " + e);
                  }
                  else {
                      if(r){
                          console.log("The document has been uploaded (fingerprint: " + fingerprint + ")");
                      }
                      console.log(r);
                  }
                });
            });
        };
      })
    });
  </script>
  </body>
</html>
